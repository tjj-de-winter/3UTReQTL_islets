#!/bin/bash

### Description ### 

# split pseudobulk BAM files into BAM files specific for each cell using the cell ID.

### Input variables ###

if [ $# -ne 2 ]
then
    echo "Usage: $0 <pseudobulk BAM file> <output path>"
    echo "Please, give as input"
    echo "1) Pseudobulk BAM file as generated by genome_alignment.sh"
    echo "2) output path for split BAM files"
    exit
fi

bam=$1
output_path=$2

### Paths to utilities and scripts ###
p2samtools=$(which samtools)

### Code ###

# extract sample ID from @RG line
sampleID=$(${p2samtools} view -h $bam | head -n400 | grep "@RG" | awk -F "ID:|\t" '{print $3}')

if [ -z "$sampleID" ]
then
      echo "No sample ID, please add a readgroup to the bam file"
      exit
fi

# Make output folder
mkdir -p $output_path

# extract cell IDs from BAM file
cells=$(${p2samtools} view ${bam} | awk -F "SM:|\t" '{print $2}' | sort | uniq)
for cell in $cells
	do
	${p2samtools} view -H ${bam} > ${output_path}/${sampleID}_${cell}.sam
done

${p2samtools} view ${bam} | awk -v path=${output_path}/${sampleID} '{cell=substr($1,index($1,"SM:")+3,length($1)); print $0 >> path"_"cell".sam"}'

for s in $(ls ${output_path}/*sam)
	do
	${p2samtools} view -h -b $s > ${s%.sam}.bam
    	rm $s	
done
	
exit
